<!DOCTYPE html>
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1" />
<head>
    <style>
    </style>
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../base.js"></script>
    <link rel="stylesheet" href="../js/jquery-ui.css"></link>
    <script type="text/javascript" src="../js/jquery-ui.js"></script>
    <script type="text/javascript" src="../js/jquery.timepicker.js"></script>
    <link rel="stylesheet" href="../js/jquery.timepicker.css"></link>
    <script type="text/javascript" src="../js/jquery-ui-timepicker-addon.js"></script>
    <script type="text/javascript" src="../js/jquery-ui-sliderAccess.js"></script>
    <script type="text/javascript" src="../js/dt/jquery.simple-dtpicker.js"></script>
    <link rel="stylesheet" href="../js/dt/jquery.simple-dtpicker.css"></link>
    <link rel="stylesheet" href="../base.css"></link>
    <script type="text/javascript" src="../irma.js"></script>
</head>
<body>

    <div>
        <a id="GoBack" href="javascript:void(0)" onclick="on_Goback(this);">Go Back</a>
    </div>
    <table id="tSearch">
        <tr>
            <th class="header" style="text-align: left;" colspan="10">
                Find a Work Instruction
        <tr>
            <td>WI No
            <td><input type="text" />
            <td>WI Job Title
            <td><input type="text" />

        <tr>
            <td> Job Category
            <td><select />
            <td>WI Type
            <td><select />
        <tr>
            <td>  Job Criticality
            <td><select />
            <td>WI Equipment Type
            <td><select />

        <tr>
            <td colspan="11" style='padding-top:4px'>
                <img src='../images/search icon.png' onclick="on_CommonSearch(this, 'usp_JobSearchWims' ,1, Callback )" />
                <img src='../images/cancel icon.png' onclick="on_Clear(this)" />
    </table>
    <table id="tSearchResult" style="display:none" class="marginBottom"></table>
    <div id="Div1">
        <img src="../Images/Submit icon.png" onclick="on_Submit(this)" />
        <img src="../Images/Cancel icon.png" onclick="window.close()" />
    </div>
    <table id="tOpen" class="marginBottom"></table>
</body>
</html>
<script>
    var tSearch = $('#tSearch')
    var tSearchResult = $('#tSearchResult')
    var tOpen = GetId('tOpen')
    var Div1 = $('#Div1')
    var IsPopup
    $(document).ready(function () {
        if (window.dialogArguments != null || getParameterByName('test') == 1)
            IsPopup = true
        InitFold()
        InitSearch()
        CleanUp()
        tSearch.find('img').eq(0).trigger('click')
        if (!IsPopup)
            InitGrid(null, 0, 1)
    })
    function InitGrid(a, group, index) {
        var t = tOpen
        var xml = GetArray(['usp_JobLandingWi', group, index, Lang])
        DataBind(t, xml)

        var total = $(xml).find('Table1').text()
        AddCommonPaging(InitGrid, t, group, total, index, Callback)

        AddGridHeader(t, 'Open WIMS')
    }
    function InitSearch() {
        var t = tSearch
        var xml = GetArray(['usp_JobFilterSearchWims'])
        t.find('tr:gt(0)').not(':last').find('td:even').addClass('labelRight')
        BindSelect(xml, t.find('select').eq(0))
        BindSelect(xml, t.find('select').last(), 1)
        var arr = ['Low', 'Medium', 'High']
        AddSelect(t, 2, arr)
        AddSelect(t, 4, arr)
        arr = ['WI', 'WIS']
        AddSelect(t, 1, arr)
        //NumberOnly([t.find(':text').eq(0)])
    }
    function on_Submit(src) {
        src = $(src)
        var root = $('<r />')
        var s = ''
        var t = tSearchResult
        var trs = src.closest('tr')
        if (IsPopup)
            trs = t.find(':checked').closest('tr')
        trs.each(function () {
            var tr = $(this)
            var wiNo = tr.children().eq(2).text()

            var xml = GetArray(['usp_JobAssociatedWI', wiNo])
            var t1 = $('<table/>')
            DataBind(t1, xml)
            t1.find('tr').eq(0).remove()
            s += tr[0].outerHTML
            s += t1.children().html()
            var type = trs.children().eq(0).attr('type')
            XmlWi(root, tr, type)
            t1.find('tr').each(function () {
                var tr1 = $(this)
                XmlWi(root, tr1, type)
            })
        })
        if (IsPopup) {
            window.returnValue = s
            window.close()
        } else {
            localStorage['WiXml'] = GetCleanXml(root)
            window.location = src.parent().attr('url')
        }
    }
    function XmlWi(root, tr, type) {
        var wi = $.createElement('wi')
        var a = tr.children().slice(1).find('a')
        var id = a.attr('href').split('id=')[1]
        wi.addAttr('id', id)
        wi.addAttr('WiNo', a.text())
        wi.addAttr('Name', GetVal(tr.children().eq(3)))
        wi.addAttr('Criticality', GetVal(tr.children().eq(4)))
        wi.addAttr('Category', GetVal(tr.children().eq(5)))
        wi.addAttr('Status', GetVal(tr.children().eq(6)))
        wi.addAttr('UserId', UserId)
        wi.addAttr('UserName', UserName)
        root.append(wi)

        var td = tr.children().eq(1)
        var arr = td.text().split(',')
        //if (td.attr('form') != null)
        //    arr =td.attr('form').split(',')
        $.each(arr, function (index, value) {
            if (value == '' || type.toUpperCase() == value.toUpperCase())
                return
            var form = $.createElement('General')
            form.addAttr('Name', value)
            root.append(form)
        });
    }
    function Callback(t) {
        AddGridHeader(t, 'Search Results')

        t.find('tr').slice(2).not(':last').each(function (index) {
            var tr = $(this)
            var url = '', id = 0, type = ''
            var form = tr.children().eq(1).text()
            if (form.indexOf('Cold Work') != -1) {
                id = -3
                type = 'cold work'
            }
            if (form.indexOf('Hot Work') != -1) {
                id = -4
                type = 'hot work'
            }
            if (form.indexOf('Confined Space') != -1) {
                id = -5
                type = 'Confined Space'
            }
            tr.children().eq(1).attr('form', form)
            if (form != '') {
                tr.children().eq(1).text('Yes')
            }
            var html = '<a href="javascript:void(0)" onclick=on_Permit(this) >Create Permit</a>'
            if (IsPopup)
                html = '<input type=checkbox />'
            else if (GetVal(tr.children().eq(1)) == '')
                html = ''
            tr.children().eq(0).html(html).attr('url', 'permit.htm?id=' + id + '&type=' + type).attr('type', type)

        })
        t.find('img').hide()
        if (IsPopup) {
            $('body').css('margin', 20)
            var html = ' <span style="margin-left:20; margin-bottom:5;  font-weight:bold" class="orangecolor"> Work Instruction </span>'
            $(html).prependTo($('body'))
            GetId('GoBack').hide()
        }
        TdByName(t, 'Form', true).hide()
        TdByName(t, 'WI No').find('a').on('click', function () {
            var a = $(this)
            var tr = a.closest('tr')

            var wiNo = a.text()
            var lang = wiNo.substring(wiNo.length - 1, wiNo.length).toUpperCase()
            if (['A', 'P'].indexOf(lang) == -1)
                lang = 'E'
            var url = a.attr('href')
            url += '&action=preview&lang=' + lang
            window.location = url
            return false
        })
        if (!IsPopup)
            GetId('Div1').hide()
        t.find('tr').eq(1).find('th').eq(0).html('')
    }

    function on_Clear(src) {
        src = $(src)
        InitClear(src.closest('table'))
    }
    function on_Permit(src) {
        src = $(src)
        var td = src.parent().next()
        td.text(td.attr('form'))
        on_Submit(src)
    }
</script>