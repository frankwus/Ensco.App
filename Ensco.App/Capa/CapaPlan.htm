<head>
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../base.js?a=1"></script>
    <link rel="stylesheet" href="../js/jquery-ui.css"></link>
    <script type="text/javascript" src="../js/jquery-ui.js"></script>
    <script type="text/javascript" src="../js/jquery.timepicker.js"></script>
    <link rel="stylesheet" href="../js/jquery.timepicker.css"></link>
    <link rel="stylesheet" href="../base.css"></link>
    <script type="text/javascript" src="../irma.js?a=1"></script>
</head>

<table border="0">
    <tr style="border:none">
        <td width="99%" style="border:none">

        <!--<td><img id="Clone" src="../Images/Clone icon.png" onclick="on_Clone(this)"  title="Clone"/>-->
        <td><img id="Save" src="../Images/save icon.png" onclick="on_Save()" Title="Save" />
        <td><img class="hidden" src="../images/history log icon.png" id="HistoryLog" onclick="on_HistoryLog()" Title="View History Log" />
        <td><img src="../Images/print.png" onclick="on_Print(this)" Title="Print Webpage" />
        <td><img src="../Images/pdf.png" onclick="on_PDF()" Title="Export to PDF" />
        <td><img src="../Images/Help icon.png" onclick="on_Help()" Title="Help" />
</table>

<table id="tPlanning">

    <tr>
        <th class="header" style="text-align: left;" colspan="24">
            Planning
    <tr>
        <td>Action Plan ID
        <td style="width:40"><span id="id"></span>
        <td>Date/Time Created
        <td id="Date">
        <td>Status
        <td id="Status">
    <tr>
        <td>Plan Title
        <td colspan="11"><input id="Title" type="text"   />
<tr>
        <td>Action Manager(s)
        <td>
            <img onclick="on_ActionManager(this)" src="../Images/Select Personnel icon.png" />
            <table border="0" id="ActionManager"></table>
        <td>Attachments
        <td colspan="5"><img src="../Images/Add Attachment icon.png" onclick="$(this).next().trigger('click')" href="javascript:void(0)" />  <input id="Document" style="display: none;" type="file">
    <tr>
        <td colspan="1">General Description
        <td colspan="13"><textarea id="Description" style="width:100%" rows="5"></textarea>
</table>
<table id="tSummary" class="marginBottom"></table>
<table id="tExecution" class="marginBottom"></table>
<table>
    <tr>
        <td>
            <img src="../Images/Assign CAPA icon 1 color.png" onclick="on_Add()" />
            <!--<span class="divider">|</span>
            <a target="_blank" href="PopupSmart.htm">Review SMARTER Actions</a>-->
</table>
<a href="javascript:void(0) " onclick="on_Submit(this)"> Submit for Verification </a>
<table id="tVerification" class="marginBottom">
    <tr>
        <th class="header" style="text-align: left;" colspan="14">
            Verification
    <tr class="labelCenter">
        <td>Role
        <td>Name
        <td>
    <tr>
        <td class="label">OIM
        <td><span class="hidden" id="OIMId"></span><span id="OIM" />
        <td>
            <input type="button" value="Verify" onclick="on_Action(this)" />
            <input type="button" value="Reject" onclick="on_Action(this)" />
</table>
<script>
    var tPlanning = $('#tPlanning')
    var tGeneral = $('#tGeneral')
    var tAuthorization = $('#tAuthorization')
    var tExecution = $('#tExecution')
    var tSummary = GetId('tSummary')
    var tVerification = $('#tVerification')
    var Id = getParameterByName('id')
    var Status
    var IsPaperView
    var Page = 'CapaPlan'
    
    var Clone = getParameterByName('clone')
    var ARR = ['id', 'Date', 'Status', 'Title',  'Description']
    $(document).ready(function () {
        if (Id == '') {
            Id = 0
            tPlanning.find('tr').eq(1).children().addClass('label')
        }
        var xml = GetArray(['usp_CapaGetCapaPlan', Id, Lang ])
        InsertCommon()
        InitFold()
        InitPlanning(xml)
        InitExecution(xml)
        InitVerification(xml)
        Status = $('#Status').text()

       LockSecurity()
       CleanUp()
       if (Id == '') {
           AddJobOwner(GetId('ActionManager').prev(), UserId, UserName)
           GetId('Clone').hide()
       }
    })
    function InitVerification(xml) {
        var t = tVerification
        DataBind(t, xml, 3)
        RemoveWingDing(t)
        AddGridHeader(t, 'Verification')
        t.find('tr').each(function () {
            var tr = $(this)
            if (tr.children().eq(1).text() == UserId && tr.children().eq(4).text() == 'Pending Approval') {
                tr.children().eq(4).html(ActionButton('Verify') + ActionButton('Reject'))
            }
        })
    }
    function on_CommonAction(src) {
        src = $(src)
        var action = GetEnglishName(src)
        var role = src.closest('tr').children().first().text()
        var section = src.closest('table').attr('id')

        section = section.substring(1, section.length)
        GetArray(['usp_JobAction', Page, section, Id, role, action, UserId])
        Refresh()
    }
    function ActionButton(name) {
        return '<input type=button onclick=on_CommonAction(this) value =' + name + ' />'
    }  
    function on_Delete(src) {
        src = $(src)
        src.closest('tr').remove()
    }
    function LockSecurity(xml) {
        var t = $('#ActionManager')
        if ( Status == 'Closed' || !t.find('[id=' + UserId + ']').length) {
            LockPage()
            tVerification.prev().remove()
        }
        t = tExecution
        var count = t.find('td:nth-child(5):contains(Closed)').length
        if (!count || t.find('tr').length != count + 2 )
            tVerification.prev().remove()
    }
    function InitPlanning(xml) {
        var t = tPlanning
        t.find('td:even').addClass('labelRight')
        t.find('tr').eq(1).children().width('15%')
        t.find('textarea').css('border', 0).parent().css('padding', 0)
        var xml1 = $(xml).find('Table1').text()

        var src = $(xml1)
        if (src == null)
            return
        for (var i in ARR) {
            var id = ARR[i]
            SetVal($('#' + id), src.attr(id))
        }
        src.find('CapaPlanOwner').each(function () {
            var element = $(this)
            AddJobOwner($('#ActionManager').prev(), element.attr('id'), element.attr('Name'))
        })
        src.find('CapaPlanAttachment').each(function () {
            var element = $(this)
            InsertAttachment($('#Document').closest('td'), element.attr('guid'), element.attr('Name'))
        })
    }
    function InitExecution(xml) {
        var t = tExecution
        DataBind(t, xml, 2)
        TdByName(t, 'No').each(function () {
            var td = $(this)
            if (GetVal(TdByName(td.parent(), 'Status')) == 'Open') {
                $( GetDelete()).appendTo(td )
            }
        })
        AddHeader(t, 'Execution')
        t = tSummary
        DataBind(t, xml, 4)
        RemoveWingDing(t )
        AddHeader(t, 'Summary')
    }
    function on_Save(submit) {        
        if (!Validate(submit ))
            return
        SaveXmlAttachment()
        var root = $('<r />')
        root.addAttr('id', Id)
        root.addAttr('submit', submit)
        XmlGeneral(root)
        tExecution.find('tr[active=1]').each(function () {
            var tr = $(this)
            var id =tr.find('a').eq(0).attr('onclick').replace('on_Add( ', '').replace(')', '')
            var element = $.createElement('Capa')
            element.addAttr('id', id )
            root.append(element)
        })
        tVerification.find('tr:gt(1)').each(function () {
            var tr = $(this)
            var element = $.createElement('Verification')
            element.addAttr('Role', tr.children().eq(0).text())
            element.addAttr('Name', tr.children().eq(1).text())
            root.append(element)
        })
        var xml = root[0].outerHTML
        xml = GetArray(['usp_CapaSaveCapaPlan', xml])
        Id = Trim($(xml).text())
        window.location = 'capaPlan.htm?id=' + Id
    }
    function GetDeleteImg() {
        return ' <img width=16 src=../Images/delete.png onclick=on_Delete(this) ></img>'
    }
    function XmlGeneral(root) {
        var element = $.createElement('General')
        for (var i in ARR) {
            var id = ARR[i]
            var value = GetVal($('#' + id))
            element.addAttr(id, value)
        }
        $('#ActionManager').find('td:odd').each(function () {
            var td = $(this)
            var JobOwner = $.createElement('actionmanager')
            JobOwner.addAttr('id', td.attr('id'))
            JobOwner.addAttr('Name', GetVal( td ))
            element.append(JobOwner)
        })
        $('#Document').siblings().find('a').each(function () {
            var a = $(this)
            var Document = $.createElement('Document')
            var guid = a.attr('href').replace('upload/', '')
            Document.addAttr('guid', guid)
            Document.addAttr('Name', a.text())
            element.append(Document)
        })
        root.append(element)
    }
    function on_Clone() {
        var xml = GetArray(['usp_CapaCloneCapaPlan', Id])
        Id = Trim($(xml).find('Column1').first().text())
        window.location = 'CapaPlan.htm?id=' + Id
    }
    function on_PobSelect(src, multiple, arr) {
        src = $(src)
        var r
        if (arr != null)
            r = arr
        else {
            r = GetPobUser()
            if (r == null)
                return
            r = r[0]
        }

        src.next().text(r[1]).attr('userId', r[0])
    }
    function Validate(submit) {
        var arr = ['ActionManager', 'Title', 'Description']
        if (submit ==1 )
            var src =tExecution.find('a').closest('tr').find('td:last-child')
        return  CommonValidate(arr, src  )           
    }
    function on_Submit(src) {
        if (!tExecution.find('a').length) {
            alert('Please fill out the Execution.')
            return 
        }
        on_Save(1)
    }

    function on_ActionManager(src) {
        src = $(src)
        var r = GetPobUser()
        if (r == null)
            return
        
        for (var i in r) {
            var arr = r[i]
            AddJobOwner(src, arr[0], arr[1])
        }
    }
    function AddJobOwner(src, id, name) {
        var t = src.next()
        var tr = AddTr(t)
        AddTd(tr, '<img src="../Images//delete.png" width="16" onclick="on_Delete(this)" />').width(1)
        AddTd(tr, name).attr('id', id)
        t.find('td').css('border', 'none')
    }
    function on_Add(id) {
        if (id == null)
            id = 0
        var url = 'Capa.htm?page=CapaPlanExecution&pageId=' + Id + '&id=' + id//+'&userid='+UserId 
        showModal (url,  '', screen.width - 20, screen.height - 100)
        Refresh()
    }

</script>
